// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = "mongodb+srv://dakshthakran05_db_user:XNuoDz8HxynA0iYG@cluster0.9awo5nj.mongodb.net/SIH_Finals?appName=Cluster0"
}

// ==================== INSTITUTE MODEL ====================
model Institute {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  instituteId String   @unique
  name        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  labs     Lab[]
  users    User[]
  students Student[] // Relation to new Student model

  @@map("institutes")
}

// ==================== USER MODEL ====================
model User {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  email         String      @unique
  password      String
  firstName     String
  lastName      String
  role          UserRole    @default(TRAINER)
  phone         String?
  department    Department?
  instituteId   String?
  institute     Institute?  @relation(fields: [instituteId], references: [instituteId], onDelete: SetNull)
  labId         String?     @db.ObjectId
  lab           Lab?        @relation(fields: [labId], references: [id], onDelete: SetNull)
  isActive      Boolean     @default(true)
  emailVerified Boolean     @default(false)

  breakdownReports   BreakdownEquipment[]
  reorderRequests    ReorderRequest[]
  reviewedReorders   ReorderRequest[]     @relation("ReviewedBy")
  notifications      Notification[]
  maintenanceLogs    MaintenanceLog[]
  markedMaintenances MaintenanceRecord[] // Track maintenance records
  reports            Report[]
  chatMessages       ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([instituteId])
  @@index([department])
  @@index([labId])
  @@map("users")
}

// ==================== STUDENT MODEL (NEW) ====================
model Student {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Personal Information
  firstName String
  lastName  String
  email     String  @unique
  phone     String?

  // Aadhaar Information
  aadhaarNumber   String  @unique
  aadhaarVerified Boolean @default(false)

  // Biometric Data (stored as encrypted hash)
  biometricHash String // Fingerprint template hash
  biometricType BiometricType @default(FINGERPRINT)

  // Institute & Lab Information
  instituteId String
  institute   Institute  @relation(fields: [instituteId], references: [instituteId])
  department  Department
  labId       String     @db.ObjectId
  lab         Lab        @relation(fields: [labId], references: [id])

  // Enrollment Details
  enrollmentNumber String  @unique
  enrollmentDate   DateTime   @default(now())
  courseType       CourseType
  batchYear        String

  // Status
  isActive Boolean @default(true)

  // Equipment Access Logs
  accessLogs EquipmentAccessLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // âœ… FIX: Removed redundant @@index for aadhaarNumber and enrollmentNumber
  @@index([instituteId])
  @@index([labId])
  @@map("students")
}

// ==================== MAINTENANCE RECORD MODEL ====================
model MaintenanceRecord {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId     String    @db.ObjectId
  equipment       Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  markedBy        String    @db.ObjectId
  markedByUser    User      @relation(fields: [markedBy], references: [id])
  maintenanceDate DateTime  @default(now())
  maintenanceType String? // e.g., "Preventive", "Corrective", "Calibration"
  notes           String?
  createdAt       DateTime  @default(now())

  @@index([equipmentId])
  @@index([maintenanceDate])
  @@map("maintenance_records")
}

// ==================== OTP MODEL ====================
model OTP {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  otp       String
  purpose   OTPPurpose
  isUsed    Boolean    @default(false)
  expiresAt DateTime
  createdAt DateTime   @default(now())

  @@index([email, purpose])
  @@index([expiresAt])
  @@map("otps")
}

enum OTPPurpose {
  REGISTRATION
  LOGIN
}

enum UserRole {
  POLICY_MAKER
  LAB_MANAGER
  TRAINER
}

// ==================== LAB MODEL ====================
model Lab {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  labId       String    @unique
  name        String
  instituteId String
  institute   Institute @relation(fields: [instituteId], references: [instituteId], onDelete: Restrict)
  department  Department
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  equipments Equipment[]
  trainers   User[]
  students   Student[] // Relation to new Student model

  @@index([instituteId])
  @@map("labs")
}

enum Department {
  FITTER_MANUFACTURING
  ELECTRICAL_ENGINEERING
  WELDING_FABRICATION
  TOOL_DIE_MAKING
  ADDITIVE_MANUFACTURING
  SOLAR_INSTALLER_PV
  MATERIAL_TESTING_QUALITY
  ADVANCED_MANUFACTURING_CNC
  AUTOMOTIVE_MECHANIC
}

// Equipment Name Enums
enum FitterEquipmentName {
  BENCH_DRILLING_MACHINE
  ANGLE_GRINDER_PORTABLE
  MANUAL_ARC_WELDING_MACHINE
  GAS_WELDING_KIT
  MIG_CO2_WELDING_MACHINE
}

enum ElectricalEquipmentName {
  ELECTRICIAN_TRAINING_PANEL
  ADVANCED_ELECTRICIAN_SETUP_PLC_VFD
  BENCH_DRILLING_MACHINE
}

enum WeldingEquipmentName {
  ARC_WELDING_MACHINE_200_300A
  GAS_WELDING_KIT_OXY_ACETYLENE
  MIG_CO2_WELDING_MACHINE_250_400A
  VR_AR_WELDING_SIMULATOR
}

enum ToolDieEquipmentName {
  TOOL_DIE_EQUIPMENT_EDM_JIG_BORING
  PLANER_MACHINE
  GEAR_HOBBING_SHAPING_MACHINE
}

enum AdditiveManufacturingEquipmentName {
  THREE_D_PRINTER_FDM_RESIN
  LASER_ENGRAVING_CUTTING_MACHINE
}

enum SolarInstallerEquipmentName {
  INVERTER_TRAINING_UNIT
  DRILLING_MACHINE_AND_TOOLS
}

enum MaterialTestingEquipmentName {
  TENSILE_TESTING_MACHINE
  COMPRESSION_TESTING_MACHINE
  IMPACT_TESTING_MACHINE_CHARPY_IZOD
  HARDNESS_TESTER_ROCKWELL_BRINELL_VICKERS
  OPTICAL_COMPARATOR
  ENVIRONMENTAL_CHAMBER
}

enum AdvancedManufacturingEquipmentName {
  CNC_VERTICAL_MACHINING_CENTER_3_4_AXIS
  CNC_LATHE_2_AXIS
}

enum AutomotiveEquipmentName {
  MOTOR_VEHICLE_TRAINING_MODEL
}

// ==================== EQUIPMENT MODEL ====================
model Equipment {
  id             String     @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId    String     @unique
  name           String
  department     Department
  labId          String     @db.ObjectId
  lab            Lab        @relation(fields: [labId], references: [id], onDelete: Restrict)
  manufacturer   String
  model          String
  serialNumber   String?
  purchaseDate   DateTime
  warrantyExpiry DateTime?
  specifications Json?
  imageUrl       String?
  isActive       Boolean    @default(true)

  // NEW: Authentication & Access Control
  requiresAuthentication Boolean              @default(false)
  isLocked               Boolean              @default(true)
  currentUserId          String?              @db.ObjectId // Tracks the student currently using it
  accessLogs             EquipmentAccessLog[] // Relation to access logs

  // Firebase device ID for realtime data (only 9 equipment in one lab)
  firebaseDeviceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Department-specific equipment names
  fitterEquipmentName                FitterEquipmentName?
  electricalEquipmentName            ElectricalEquipmentName?
  weldingEquipmentName               WeldingEquipmentName?
  toolDieEquipmentName               ToolDieEquipmentName?
  additiveManufacturingEquipmentName AdditiveManufacturingEquipmentName?
  solarInstallerEquipmentName        SolarInstallerEquipmentName?
  materialTestingEquipmentName       MaterialTestingEquipmentName?
  advancedManufacturingEquipmentName AdvancedManufacturingEquipmentName?
  automotiveEquipmentName            AutomotiveEquipmentName?

  // Relations
  status             EquipmentStatus?
  sensorData         SensorData[]
  alerts             Alert[]
  maintenanceLogs    MaintenanceLog[]
  maintenanceRecords MaintenanceRecord[]
  usageAnalytics     UsageAnalytics[]
  breakdownRecords   BreakdownEquipment[]
  analyticsParams    DepartmentAnalytics?

  @@index([labId])
  @@index([department])
  @@index([firebaseDeviceId])
  @@map("equipment")
}

// ==================== EQUIPMENT ACCESS LOG MODEL (NEW) ====================
model EquipmentAccessLog {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Student Information
  studentId String  @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Equipment Information
  equipmentId String    @db.ObjectId
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  // Authentication Details
  aadhaarVerified    Boolean @default(false)
  biometricVerified  Boolean @default(false)
  verificationMethod String? // "AADHAAR_BIOMETRIC", "AADHAAR_OTP"

  // Session Information
  accessGrantedAt DateTime  @default(now())
  accessRevokedAt DateTime?
  sessionDuration Int? // Duration in minutes

  // Status
  accessStatus  AccessStatus @default(GRANTED)
  failureReason String?

  // Audit Trail
  ipAddress  String?
  deviceInfo String?

  createdAt DateTime @default(now())

  @@index([studentId, equipmentId])
  @@index([accessGrantedAt])
  @@map("equipment_access_logs")
}

// ==================== DEPARTMENT-SPECIFIC ANALYTICS ====================
model DepartmentAnalytics {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId String     @unique @db.ObjectId
  equipment   Equipment  @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  department  Department

  // REQUIRED parameters (tracked by hardware)
  temperature       Float // Current temperature (REQUIRED)
  vibration         Float // Current vibration (REQUIRED)
  energyConsumption Float // Power consumption in Watts (REQUIRED)

  // Common parameters
  efficiency      Float? // Efficiency percentage
  totalUptime     Float  @default(0)
  totalDowntime   Float  @default(0)
  utilizationRate Float  @default(0)

  // Optional department-specific parameters
  arcStability        Float?
  weldQuality         Float?
  voltage             Float?
  current             Float?
  powerFactor         Float?
  testAccuracy        Float?
  calibrationStatus   String?
  loadCapacity        Float?
  spindleSpeed        Float?
  feedRate            Float?
  toolWear            Float?
  dimensionalAccuracy Float?
  printQuality        Float?
  layerHeight         Float?
  materialUsage       Float?
  solarEfficiency     Float?
  powerOutput         Float?
  batteryHealth       Float?
  enginePerformance   Float?
  fuelEfficiency      Float?
  precisionLevel      Float?
  surfaceFinish       Float?

  updatedAt DateTime @updatedAt

  @@map("department_analytics")
}

// ==================== EQUIPMENT STATUS ====================
model EquipmentStatus {
  id                  String            @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId         String            @unique @db.ObjectId
  equipment           Equipment         @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  status              OperationalStatus @default(IDLE)
  healthScore         Float             @default(100)
  isOperatingInClass  Boolean           @default(false)
  currentOperator     String?
  lastMaintenanceDate DateTime? // Automatically updated from MaintenanceRecord
  nextMaintenanceDate DateTime?

  // Real-time tracked parameters (from Firebase)
  temperature       Float?
  vibration         Float?
  energyConsumption Float?

  lastUsedAt DateTime?
  updatedAt  DateTime  @updatedAt

  @@map("equipment_status")
}

enum OperationalStatus {
  OPERATIONAL
  IN_USE
  IN_CLASS
  IDLE
  MAINTENANCE
  FAULTY
  OFFLINE
  WARNING
}

// ==================== SENSOR DATA ====================
model SensorData {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId String    @db.ObjectId
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  timestamp   DateTime  @default(now())

  // Core tracked parameters
  temperature       Float
  vibration         Float
  energyConsumption Float

  // Optional parameters
  pressure     Float?
  humidity     Float?
  voltage      Float?
  current      Float?
  rpm          Float?
  powerFactor  Float?
  loadForce    Float?
  isAnomaly    Boolean @default(false)
  anomalyScore Float?

  @@index([equipmentId, timestamp(sort: Desc)])
  @@map("sensor_data")
}

model Alert {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId String        @db.ObjectId
  equipment   Equipment     @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  type        AlertType
  severity    AlertSeverity
  title       String
  message     String
  isResolved  Boolean       @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime      @default(now())
  notifications Notification[]

  @@index([equipmentId, createdAt(sort: Desc)])
  @@map("alerts")
}

enum AlertType {
  FAULT_DETECTED
  HIGH_TEMPERATURE
  ABNORMAL_VIBRATION
  HIGH_ENERGY_CONSUMPTION
  MAINTENANCE_DUE
  WARRANTY_EXPIRING
  EQUIPMENT_BREAKDOWN_CHECK
  UNSAFE_USAGE
  UNSAFE_PATTERN_DETECTED
  EQUIPMENT_OFFLINE
  LOW_HEALTH_SCORE
  CUSTOM
}

enum AlertSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

model Notification {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  userId    String           @db.ObjectId
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  alertId   String?          @db.ObjectId
  alert     Alert?           @relation(fields: [alertId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@map("notifications")
}

enum NotificationType {
  ALERT
  MAINTENANCE
  BREAKDOWN_ALERT
  REORDER_REQUEST
  REPORT
  SYSTEM
  CHAT
  UNSAFE_PATTERN
}

model MaintenanceLog {
  id            String            @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId   String            @db.ObjectId
  equipment     Equipment         @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  type          MaintenanceType
  status        MaintenanceStatus @default(SCHEDULED)
  scheduledDate DateTime
  completedDate DateTime?
  description   String
  notes         String?
  cost          Float?
  technicianId  String            @db.ObjectId
  technician    User              @relation(fields: [technicianId], references: [id])
  partsReplaced Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([equipmentId, scheduledDate(sort: Desc)])
  @@map("maintenance_logs")
}

enum MaintenanceType {
  PREVENTIVE
  PREDICTIVE
  CORRECTIVE
  EMERGENCY
  ROUTINE
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

model UsageAnalytics {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId     String    @db.ObjectId
  equipment       Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  date            DateTime
  totalUsageHours Float     @default(0)
  totalDowntime   Float     @default(0)
  utilizationRate Float     @default(0)
  efficiency      Float     @default(0)
  sessionsCount   Int       @default(0)
  classSessions   Int       @default(0)
  avgSessionTime  Float     @default(0)
  energyConsumed  Float     @default(0)
  createdAt       DateTime  @default(now())

  @@unique([equipmentId, date])
  @@index([equipmentId, date(sort: Desc)])
  @@map("usage_analytics")
}

model Report {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  reportType  ReportType
  title       String
  dateFrom    DateTime
  dateTo      DateTime
  generatedBy String     @db.ObjectId
  user        User       @relation(fields: [generatedBy], references: [id])
  data        Json
  fileUrl     String?
  createdAt   DateTime   @default(now())

  @@index([generatedBy, createdAt(sort: Desc)])
  @@map("reports")
}

enum ReportType {
  DAILY_SUMMARY
  WEEKLY_SUMMARY
  MONTHLY_SUMMARY
  EQUIPMENT_HEALTH
  MAINTENANCE_HISTORY
  USAGE_ANALYTICS
  ALERT_HISTORY
  ENERGY_CONSUMPTION
  DEPARTMENT_SUMMARY
  LIFECYCLE_REPORT
  CUSTOM
}

model ChatMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   String
  response  String?
  intent    String?
  createdAt DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@map("chat_messages")
}

model SystemConfig {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_config")
}

model BreakdownEquipment {
  id              String          @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId     String          @db.ObjectId
  equipment       Equipment       @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  reportedBy      String          @db.ObjectId
  reportedByUser  User            @relation(fields: [reportedBy], references: [id])
  reason          String?
  reportedAt      DateTime        @default(now())
  isAutoDetected  Boolean         @default(false)
  status          BreakdownStatus @default(REPORTED)
  reorderRequests ReorderRequest[]

  @@index([equipmentId])
  @@index([reportedBy])
  @@map("breakdown_equipment")
}

enum BreakdownStatus {
  REPORTED
  REORDER_PENDING
  REORDER_APPROVED
  REORDER_REJECTED
  RESOLVED
}

model ReorderRequest {
  id              String             @id @default(auto()) @map("_id") @db.ObjectId
  breakdownId     String             @db.ObjectId
  breakdown       BreakdownEquipment @relation(fields: [breakdownId], references: [id], onDelete: Cascade)
  requestedBy     String             @db.ObjectId
  requestedByUser User               @relation(fields: [requestedBy], references: [id])
  equipmentName   String
  quantity        Int                @default(1)
  urgency         ReorderUrgency     @default(MEDIUM)
  reason          String
  estimatedCost   Float?
  status          ReorderStatus      @default(PENDING)
  reviewedBy      String?            @db.ObjectId
  reviewedByUser  User?              @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  reviewedAt      DateTime?
  reviewComments  String?
  requestedAt     DateTime           @default(now())

  @@index([breakdownId])
  @@index([requestedBy])
  @@index([status])
  @@map("reorder_requests")
}

enum ReorderUrgency {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ReorderStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model SLDLayout {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  labId      String   @unique
  numColumns Int      @default(4)
  positions  Json
  updatedBy  String   @db.ObjectId
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("sld_layouts")
}

// ==================== NEW ENUMS ====================
enum BiometricType {
  FINGERPRINT
  IRIS
  FACE
}

enum CourseType {
  CERTIFICATE
  DIPLOMA
  ADVANCED_DIPLOMA
  SHORT_TERM
}

enum AccessStatus {
  GRANTED
  DENIED
  REVOKED
  EXPIRED
}